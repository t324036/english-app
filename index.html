<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Dictionary</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #333;
            --bottom-bar-height: 80px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            padding-bottom: calc(var(--bottom-bar-height) + 60px);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- ç”»åƒã‚¨ãƒªã‚¢ --- */
        .hero-image {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .hero-image:active {
            transform: scale(0.98);
        }

        /* --- æ¤œç´¢çµæœã‚¨ãƒªã‚¢ --- */
        .result-area {
            width: 100%;
            min-height: 100px;
        }

        .result-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: left;
            animation: fadeIn 0.3s ease;
            margin-bottom: 20px;
        }

        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .word-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* ç™ºéŸ³ãƒœã‚¿ãƒ³ */
        .speak-btn {
            background: #eef2f6;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #555;
            transition: 0.2s;
        }
        .speak-btn:hover {
            background: #dfe6f0;
            color: var(--primary-color);
        }
        .speak-btn:active {
            transform: scale(0.9);
        }

        .source-badge {
            font-size: 10px;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            color: #666;
            margin-left: 8px;
            vertical-align: middle;
        }

        .word-def {
            line-height: 1.6;
            color: #444;
            white-space: pre-wrap;
        }

        .action-btns {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ext-link-btn {
            text-decoration: none;
            font-size: 13px;
            color: var(--primary-color);
            background: rgba(0, 122, 255, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            transition: 0.2s;
        }

        /* --- ä¸‹éƒ¨å›ºå®šæ¤œç´¢ãƒãƒ¼ --- */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.1);
            padding: 10px 20px 20px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .suggestion-scroller {
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            min-height: 36px;
            display: flex;
            align-items: center;
        }
        .suggestion-scroller::-webkit-scrollbar {
            display: none;
        }

        .predict-btn {
            background: #eef2f6;
            color: #444;
            border: none;
            padding: 6px 14px;
            margin-right: 8px;
            border-radius: 18px;
            font-size: 14px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .predict-btn.jp-match {
            background: #e3f2fd;
            color: #007AFF;
            border: 1px solid #bbdefb;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        input[type="text"] {
            width: 100%;
            padding: 14px 40px 14px 16px;
            font-size: 16px;
            border: 2px solid #e1e4e8;
            border-radius: 25px;
            outline: none;
            background: #f8f9fa;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        input[type="text"]:focus {
            border-color: var(--primary-color);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0,122,255,0.1);
        }

        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #ccc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .loading-text {
            color: #888;
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <img src="image_0a4bfc.png" alt="Main Visual" class="hero-image" id="heroImage">

    <div id="resultArea" class="result-area"></div>
    <div id="loadingMsg" class="loading-text">è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
</div>

<div class="bottom-bar">
    <div id="suggestionArea" class="suggestion-scroller"></div>
    <div class="input-wrapper">
        <input type="text" id="searchInput" placeholder="å˜èªã‚’å…¥åŠ› (ä¾‹: apple, èµ°ã‚‹)" autocomplete="off">
        <button id="clearBtn" class="clear-btn">Ã—</button>
    </div>
</div>

<script>
    let dictionary = {};
    let isDictLoaded = false;
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const resultArea = document.getElementById('resultArea');
    const suggestionArea = document.getElementById('suggestionArea');
    const loadingMsg = document.getElementById('loadingMsg');
    const heroImage = document.getElementById('heroImage');

    heroImage.addEventListener('click', () => {
        searchInput.focus();
    });

    // è¾æ›¸èª­ã¿è¾¼ã¿
    fetch('ejdict-hand-utf8.txt')
        .then(response => response.text())
        .then(text => {
            const lines = text.split('\n');
            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 2) {
                    dictionary[parts[0].trim()] = parts[1].trim();
                }
            });
            isDictLoaded = true;
            loadingMsg.style.display = 'none';
            searchInput.placeholder = "æ¤œç´¢ã§ãã¾ã™";
        })
        .catch(err => {
            loadingMsg.textContent = "ãƒ­ãƒ¼ã‚«ãƒ«è¾æ›¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¤œç´¢ã¯å¯èƒ½ã§ã™ã€‚";
            isDictLoaded = true;
        });

    let debounceTimer;
    searchInput.addEventListener('input', (e) => {
        const val = e.target.value;
        clearBtn.style.display = val.length > 0 ? 'flex' : 'none';

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            performSearch(val.trim());
        }, 500); // APIè² è·è»½æ¸›ã®ãŸã‚å°‘ã—é•·ã‚ã«å¾…ã¤
    });

    clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        resultArea.innerHTML = '';
        suggestionArea.innerHTML = '';
        searchInput.focus();
    });

    // æ¤œç´¢å®Ÿè¡Œã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
    async function performSearch(word) {
        if (!word) {
            resultArea.innerHTML = '';
            suggestionArea.innerHTML = '';
            return;
        }

        resultArea.innerHTML = ''; // ã‚¯ãƒªã‚¢
        const lowerWord = word.toLowerCase();
        let foundLocally = false;

        // 1. ãƒ­ãƒ¼ã‚«ãƒ«è¾æ›¸æ¤œç´¢
        if (dictionary[lowerWord]) {
            createResultCard(lowerWord, dictionary[lowerWord], 'Local Dictionary');
            foundLocally = true;
        }

        // 2. æ—¥æœ¬èªã®å ´åˆã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«è¾æ›¸æ¤œç´¢ã¯ã—ãªã„ï¼ˆé€†å¼•ãã®ã¿ï¼‰
        // è‹±èªã‹ã¤ãƒ­ãƒ¼ã‚«ãƒ«ã«ãªã‹ã£ãŸå ´åˆã®ã¿ã€å¤–éƒ¨APIã‚’å©ã
        if (!foundLocally && !word.match(/[ä¸€-é¾ ã-ã‚“ã‚¡-ãƒ³]/)) {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loading = document.createElement('div');
            loading.className = 'loading-text';
            loading.textContent = 'å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢ä¸­...';
            resultArea.appendChild(loading);

            try {
                // Free Dictionary API ã‚’ä½¿ç”¨
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${lowerWord}`);
                
                if (resultArea.contains(loading)) resultArea.removeChild(loading);

                if (res.ok) {
                    const data = await res.json();
                    if (data && data.length > 0) {
                        // APIã®çµæœã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
                        const defs = data[0].meanings.map(m => {
                            return `[${m.partOfSpeech}] ` + m.definitions.map(d => d.definition).join(' / ');
                        }).join('\n\n');
                        
                        createResultCard(data[0].word, defs, 'Online Dictionary (English)');
                    } else {
                        showNotFound(word);
                    }
                } else {
                    showNotFound(word);
                }
            } catch (e) {
                if (resultArea.contains(loading)) resultArea.removeChild(loading);
                showNotFound(word);
            }
        } else if (!foundLocally && word.match(/[ä¸€-é¾ ã-ã‚“ã‚¡-ãƒ³]/)) {
            // æ—¥æœ¬èªå…¥åŠ›ã§ãƒ’ãƒƒãƒˆãªã—ã®å ´åˆ
            // ã“ã“ã§ã¯ç‰¹ã«ä½•ã‚‚ã—ãªã„ï¼ˆå€™è£œè¡¨ç¤ºã®ã¿ã«ä»»ã›ã‚‹ï¼‰
        }

        // 3. äºˆæ¸¬å¤‰æ›ãƒ»é¡ä¼¼èªç”Ÿæˆ
        generateSuggestions(word);
    }

    // çµæœã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
    function createResultCard(word, def, source) {
        const card = document.createElement('div');
        card.className = 'result-card';
        const alcUrl = `https://eow.alc.co.jp/search?q=${encodeURIComponent(word)}`;
        
        card.innerHTML = `
            <div class="word-header">
                <div>
                    <span class="word-title">${word}</span>
                    <span class="source-badge">${source}</span>
                </div>
                <button class="speak-btn" onclick="speak('${word}')">ğŸ”Š</button>
            </div>
            <div class="word-def">${def}</div>
            <div class="action-btns">
                <a href="${alcUrl}" target="_blank" class="ext-link-btn">ğŸ“– ä¾‹æ–‡æ¤œç´¢ (ã‚¢ãƒ«ã‚¯)</a>
            </div>
        `;
        resultArea.appendChild(card);
    }

    // è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®è¡¨ç¤º
    function showNotFound(word) {
        const card = document.createElement('div');
        card.className = 'result-card';
        const alcUrl = `https://eow.alc.co.jp/search?q=${encodeURIComponent(word)}`;
        
        card.innerHTML = `
            <div class="word-header">
                <span class="word-title">${word}</span>
            </div>
            <div class="word-def" style="color:#888;">
                è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                å¤–éƒ¨ã‚µã‚¤ãƒˆã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
            </div>
            <div class="action-btns">
                <a href="${alcUrl}" target="_blank" class="ext-link-btn">ğŸ“– ã‚¢ãƒ«ã‚¯ã§æ¤œç´¢</a>
                <a href="https://ejje.weblio.jp/content/${encodeURIComponent(word)}" target="_blank" class="ext-link-btn">ğŸ” Weblioã§æ¤œç´¢</a>
            </div>
        `;
        resultArea.appendChild(card);
    }

    // ç™ºéŸ³æ©Ÿèƒ½ (Web Speech API)
    function speak(text) {
        if ('speechSynthesis' in window) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'en-US'; // è‹±èªè¨­å®š
            uttr.rate = 1.0; // é€Ÿåº¦
            window.speechSynthesis.cancel(); // å‰ã®ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            window.speechSynthesis.speak(uttr);
        } else {
            alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        }
    }

    // äºˆæ¸¬ãƒ»é€†å¼•ããƒ­ã‚¸ãƒƒã‚¯
    function generateSuggestions(inputVal) {
        suggestionArea.innerHTML = '';
        if (inputVal.length < 1) return;

        const suggestions = [];
        const lowerInput = inputVal.toLowerCase();
        const isJapanese = inputVal.match(/[ä¸€-é¾ ã-ã‚“ã‚¡-ãƒ³]/);

        if (isJapanese) {
            const jpSuggestions = getJpPredict(inputVal);
            jpSuggestions.forEach(item => {
                suggestions.push({ word: item.word, type: 'jp' });
            });
        } else {
            let count = 0;
            const keys = Object.keys(dictionary);
            for (let i = 0; i < keys.length; i++) {
                if (keys[i].startsWith(lowerInput) && keys[i] !== lowerInput) {
                    suggestions.push({ word: keys[i], type: 'en' });
                    count++;
                }
                if (count >= 10) break;
            }
        }

        if (suggestions.length > 0) {
            suggestions.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'predict-btn';
                if (item.type === 'jp') btn.classList.add('jp-match');
                btn.textContent = item.word;
                btn.onclick = () => {
                    searchInput.value = item.word;
                    clearBtn.style.display = 'flex';
                    performSearch(item.word);
                };
                suggestionArea.appendChild(btn);
            });
            suggestionArea.scrollLeft = 0;
        } else if (isJapanese) {
            const msg = document.createElement('span');
            msg.style.fontSize = '12px';
            msg.style.color = '#888';
            msg.style.padding = '0 10px';
            msg.textContent = 'å€™è£œãªã—';
            suggestionArea.appendChild(msg);
        }
    }

    function getJpPredict(text) {
        const scores = [];
        const inputBigrams = getBigrams(text);
        if (inputBigrams.length === 0) return [];

        let scanCount = 0;
        for (const [key, desc] of Object.entries(dictionary)) {
            scanCount++;
            if (scanCount > 15000) break;

            let matchCount = 0;
            if (desc.includes(text)) {
                matchCount += 10;
            } else {
                const targetBigrams = getBigrams(desc);
                inputBigrams.forEach(gram => {
                    if (targetBigrams.includes(gram)) matchCount++;
                });
            }

            if (matchCount > 0) {
                scores.push({ word: key, score: matchCount });
            }
        }
        scores.sort((a, b) => b.score - a.score);
        return scores.slice(0, 6);
    }

    function getBigrams(text) {
        const clean = text.replace(/[^a-zA-Z0-9ä¸€-é¾ ã-ã‚“ã‚¡-ãƒ³ãƒ¼]/g, "");
        const grams = [];
        for (let i = 0; i < clean.length - 1; i++) {
            grams.push(clean.substring(i, i + 2));
        }
        return grams;
    }
</script>

</body>
</html>
